<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarePilot Urgent - Analytics</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <div class="brand">CarePilot Urgent</div>
        {% if demo_mode %}<span class="demo-badge">DEMO MODE</span>{% endif %}
      </div>
      <nav class="nav">
        <a href="/">Portal</a>
        <a href="/staff">Staff</a>
        <a class="active" href="/analytics">Analytics</a>
        <form method="post" action="/staff/logout" style="display:inline;">
          <button type="submit" class="btn secondary" style="padding:.35rem .6rem;">Logout</button>
        </form>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 class="title">Operational Analytics</h1>
    <p class="muted">Forecasting and what-if staffing impact for the next 2 hours.</p>

    <div class="card">
      <label for="providers">Providers available (what-if)</label>
      <input id="providers" type="range" min="1" max="3" value="{{ provider_count }}">
      <div class="muted">Provider count: <strong id="providers-value">{{ provider_count }}</strong></div>
    </div>

    <div class="grid three">
      <div class="card"><div class="muted">Current Queue</div><div class="kpi" id="k-queue">0</div></div>
      <div class="card"><div class="muted">Current Avg Wait</div><div class="kpi" id="k-wait">0 min</div></div>
      <div class="card"><div class="muted">Predicted Peak Wait</div><div class="kpi" id="k-peak">0 min</div></div>
    </div>

    <div class="card" style="margin-top:1rem;">
      <div class="muted">Lane Routing Mix</div>
      <div class="kpi" id="lane-mix-analytics">Fast 0 • Standard 0 • Complex 0</div>
    </div>

    <div class="grid two">
      <div class="card">
        <h3 class="title">Predicted Arrivals (next 2h)</h3>
        <canvas id="arrivals-chart" width="520" height="220"></canvas>
      </div>
      <div class="card">
        <h3 class="title">Predicted Wait Projection</h3>
        <canvas id="wait-chart" width="520" height="220"></canvas>
      </div>
    </div>

    <div class="card">
      <h3 class="title">Recommended Action</h3>
      <p id="recommendation" class="muted">Loading...</p>
    </div>
  </main>

  <script>
    function drawLineChart(canvasId, labels, values, color) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, w, h);
      const pad = 30;
      const max = Math.max(1, ...values);
      const stepX = (w - pad * 2) / Math.max(1, values.length - 1);

      ctx.strokeStyle = '#cbd5e1';
      ctx.beginPath();
      ctx.moveTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.stroke();

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = pad + i * stepX;
        const y = h - pad - ((v / max) * (h - pad * 2));
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = '#334155';
      ctx.font = '11px sans-serif';
      values.forEach((v, i) => {
        const x = pad + i * stepX;
        const y = h - pad - ((v / max) * (h - pad * 2));
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();
        if (labels[i]) ctx.fillText(labels[i], x - 14, h - 10);
      });
    }

    function loadAnalytics() {
      const providers = document.getElementById('providers').value;
      document.getElementById('providers-value').textContent = providers;
      fetch('/api/analytics?providers=' + encodeURIComponent(providers))
        .then(function (r) {
          if (r.status === 401) {
            window.location = '/staff/login';
            throw new Error('unauthorized');
          }
          return r.json();
        })
        .then(function (data) {
          document.getElementById('k-queue').textContent = data.current_queue;
          document.getElementById('k-wait').textContent = data.current_avg_wait + ' min';
          const peak = Math.max(...data.forecast.wait_projection, data.current_peak_wait || 0);
          document.getElementById('k-peak').textContent = peak + ' min';
          const lc = data.lane_counts || {};
          document.getElementById('lane-mix-analytics').textContent =
            'Fast ' + (lc.Fast || 0) + ' • Standard ' + (lc.Standard || 0) + ' • Complex ' + (lc.Complex || 0);
          document.getElementById('recommendation').textContent = data.forecast.recommendation;
          drawLineChart('arrivals-chart', data.forecast.labels, data.forecast.arrivals, '#0ea5e9');
          drawLineChart('wait-chart', data.forecast.labels, data.forecast.wait_projection, '#f59e0b');
        });
    }

    document.getElementById('providers').addEventListener('input', loadAnalytics);
    loadAnalytics();
    setInterval(loadAnalytics, 4000);
  </script>
</body>
</html>
