<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarePilot Urgent - Waiting Room</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="a11y-bar" role="region" aria-label="Accessibility and language">
    <button type="button" id="a11y-large" class="btn-a11y" aria-pressed="false">Large text</button>
    <button type="button" id="a11y-contrast" class="btn-a11y" aria-pressed="false">High contrast</button>
    <span class="lang-toggle" aria-label="Language"><button type="button" data-lang="en">EN</button><button type="button" data-lang="ar">AR</button></span>
  </div>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <div class="brand">CarePilot Urgent</div>
        {% if demo_mode %}<span class="demo-badge">DEMO MODE</span>{% endif %}
      </div>
      <nav class="nav">
        <a href="/">Portal</a>
        <a class="active" href="/display">Display</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 class="title">Waiting Room Display</h1>
    <p class="muted">Token-only queue (privacy-safe). Real-time updates enabled.</p>
    <p class="microcopy">This screen contains no medical details.</p>
    <div class="card" style="margin-bottom:.8rem;">
      <div class="muted">Lobby Occupancy</div>
      <div class="kpi" id="lobby-load">Low</div>
    </div>
    <div id="queue" class="table-like"></div>
  </main>

  <script>
    function esc(v) {
      const d = document.createElement('div');
      d.textContent = String(v ?? '');
      return d.innerHTML;
    }
    function freshnessLabel(updatedAt) {
      if (!updatedAt) return 'Updated just now';
      const then = new Date(updatedAt).getTime();
      if (!then) return 'Updated just now';
      const sec = Math.max(0, Math.floor((Date.now() - then) / 1000));
      return 'Updated ' + sec + 's ago';
    }
    function render(items) {
      const q = document.getElementById('queue');
      if (!items || !items.length) {
        q.innerHTML = '<div class="card muted">No patients currently in queue.</div>';
        return;
      }
      q.innerHTML = items.map(function (i) {
        return '<div class="patient-row">' +
          '<div style="display:flex;justify-content:space-between;gap:1rem;align-items:center;">' +
            '<div><strong>' + esc(i.token) + '</strong><br>' +
            '<span class="muted">Estimated wait: ' + esc(i.estimated_wait_min) + ' min</span><br>' +
            '<span class="muted">Position: #' + esc(i.position_in_line) + ' • Providers: ' + esc(i.providers_active) + '</span><br>' +
            '<span class="microcopy">' + esc(i.eta_explanation || '') + ' • ' + esc(freshnessLabel(i.updated_at)) + '</span></div>' +
            '<span class="status-pill">' + esc(i.status_label) + '</span>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    function connectWs() {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(proto + '://' + location.host + '/ws/queue');
      ws.onmessage = function (event) {
        try {
          const payload = JSON.parse(event.data);
          if (payload && payload.items) render(payload.items);
        } catch (e) {}
      };
      ws.onclose = function () { setTimeout(connectWs, 1200); };
      ws.onerror = function () { ws.close(); };
    }
    function loadLobby() {
      fetch('/api/lobby-load')
        .then(function (r) { return r.json(); })
        .then(function (x) {
          document.getElementById('lobby-load').textContent = x.level + ' (' + x.queue_size + ' waiting)';
        });
    }
    function poll() {
      fetch('/api/queue')
        .then(function (r) { return r.json(); })
        .then(render)
        .catch(function () { render([]); });
    }
    poll();
    loadLobby();
    connectWs();
    setInterval(poll, 2000);
    setInterval(loadLobby, 4000);
  </script>
  <script src="/static/ux.js"></script>
</body>
</html>
