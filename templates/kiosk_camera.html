<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarePilot Urgent - Camera Kiosk</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="a11y-bar" role="region" aria-label="Accessibility and language">
    <button type="button" id="a11y-large" class="btn-a11y" aria-pressed="false">Large text</button>
    <button type="button" id="a11y-contrast" class="btn-a11y" aria-pressed="false">High contrast</button>
    <span class="lang-toggle" aria-label="Language"><button type="button" data-lang="en">EN</button><button type="button" data-lang="ar">AR</button></span>
  </div>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <div class="brand">CarePilot Urgent</div>
        {% if demo_mode %}<span class="demo-badge">DEMO MODE</span>{% endif %}
      </div>
      <nav class="nav">
        <a href="/">Portal</a>
        <a href="/kiosk">Manual Kiosk</a>
        <a class="active" href="/kiosk/camera">Camera Kiosk</a>
        <a href="/display">Display</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h1 class="title">Camera QR Check-in</h1>
      <p class="muted">Point the patient's QR code at the USB camera. This station shows token and wait only.</p>
      <div id="status-box" class="card" style="border-left:4px solid var(--primary); margin-top:.8rem;">
        <strong id="status-text">Scanning for QR...</strong>
      </div>
    </div>

    <div class="grid two" style="margin-top:1rem;">
      <div class="card">
        <img id="camera-feed" src="/camera/stream" alt="Live camera stream" style="width:100%; border-radius:12px; border:1px solid var(--border);">
        <p class="microcopy" style="margin-top:.55rem;">For workflow assistance only. This kiosk does not provide medical diagnosis.</p>
      </div>
      <div class="card">
        <h3 class="title">Last Check-in</h3>
        <div id="success-card" class="card" style="display:none; border-left:4px solid var(--ok);">
          <h2 class="title" id="checkin-banner">✅ CHECKED IN</h2>
          <div class="token-card" id="token-out">UC-0000</div>
          <p class="muted" id="message-out">Checked in.</p>
          <p class="muted">Estimated wait: <strong id="wait-out">0</strong> min</p>
        </div>

        <div class="btn-row" style="margin-top:.7rem;">
          <button class="btn secondary" type="button" id="resume-btn">Resume scanning</button>
        </div>

        <hr class="hr">
        <h3 class="title">Manual Fallback</h3>
        <form id="manual-form">
          <label for="manual-code">Token / code</label>
          <input id="manual-code" type="text" placeholder="UC-1234 or A1B2C3D4" required>
          <button class="btn ok" type="submit">Check In</button>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:1rem;">
      <h3 class="title">AI Voice Assistant (Operational, Non-diagnostic)</h3>
      <p class="microcopy">This assistant helps with kiosk steps only. If emergency symptoms, alert staff immediately.</p>
      <div class="btn-row" style="margin-top:.6rem;">
        <button id="mic-btn" type="button" class="btn">Start Listening</button>
        <span id="voice-state" class="status-pill">Idle</span>
      </div>
      <div id="assistant-alert" class="card" style="display:none; border-left:4px solid var(--danger); margin-top:.7rem;">
        <strong>Red-flag phrase detected. Please call staff now.</strong>
      </div>
      <div id="transcript" class="table-like" style="margin-top:.7rem;"></div>
    </div>
    
    <div class="ai-assistant">
      <div class="ai-title">AI Voice Assistant</div>
    
      <div id="aiStatus" class="ai-status">Waiting for QR scan…</div>
    
      <div id="priorityBox" class="priority low" style="margin-top:12px;">
        <div class="priority-label">Priority</div>
        <div id="priorityValue" class="priority-value">—</div>
        <div id="priorityReason" class="priority-reason">—</div>
      </div>
    </div>

  </main>

  <script>
    (function () {
      const statusText = document.getElementById('status-text');
      const successCard = document.getElementById('success-card');
      const tokenOut = document.getElementById('token-out');
      const waitOut = document.getElementById('wait-out');
      const messageOut = document.getElementById('message-out');
      const manualForm = document.getElementById('manual-form');
      const manualCode = document.getElementById('manual-code');
      const resumeBtn = document.getElementById('resume-btn');
      const micBtn = document.getElementById('mic-btn');
      const voiceState = document.getElementById('voice-state');
      const transcript = document.getElementById('transcript');
      const assistantAlert = document.getElementById('assistant-alert');

      let scanningEnabled = true;
      let submitting = false;
      let cooldownUntil = 0;
      let lastProcessedValue = '';

      function setStatus(msg) {
        statusText.textContent = msg;
      }

      function beep() {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        const ctx = new Ctx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 880;
        gain.gain.value = 0.0001;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.22, ctx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.22);
        osc.stop(ctx.currentTime + 0.24);
      }

      function showSuccess(data) {
        tokenOut.textContent = data.token || 'UC-0000';
        waitOut.textContent = String(data.estimated_wait_min || 0);
        messageOut.textContent = 'Checked in \u2705 ' + (data.message || '');
        successCard.style.display = 'block';
        beep();
      }

      function addBubble(role, text) {
        const row = document.createElement('div');
        row.className = 'card';
        row.innerHTML = '<strong>' + (role === 'assistant' ? 'Assistant' : 'You') + ':</strong> ' + text;
        transcript.prepend(row);
      }

      async function sendAssistantMessage(text) {
        try {
          const fd = new FormData();
          fd.append('message', text);
          fd.append('role', 'patient');
          const r = await fetch('/api/ai/chat', { method: 'POST', body: fd });
          const data = await r.json();
          addBubble('assistant', data.reply || 'Unable to respond.');
          if (data.red_flags && data.red_flags.length) {
            assistantAlert.style.display = 'block';
            beep();
          }
          if ('speechSynthesis' in window && data.reply) {
            const ut = new SpeechSynthesisUtterance(data.reply);
            window.speechSynthesis.speak(ut);
          }
        } catch (e) {
          addBubble('assistant', 'Assistant unavailable right now.');
        }
      }

      async function submitCode(code, fromCamera) {
        if (!code || submitting) return;
        submitting = true;
        setStatus(fromCamera ? 'QR detected, checking in...' : 'Checking in...');
        try {
          const fd = new FormData();
          fd.append('code', code);
          const r = await fetch('/api/kiosk-checkin', { method: 'POST', body: fd });
          const data = await r.json();

          // If backend says cooldown, silently ignore camera resubmits (no scary UI)
          if (String(data.message || '').toLowerCase().includes('cooldown')) {
            // keep scanning enabled; don't change status to cooldown error
            return;
          }

          if (data.ok && data.checked_in) {
            showSuccess(data);

            // ✅ IMPORTANT FIX:
            // Trigger AI flow ONLY AFTER successful check-in (so we DO NOT hit /api/kiosk-checkin twice).
            // This prevents: "Scan cooldown active. Please wait 3 seconds."
            if (window.CarePilotAIVoice && typeof window.CarePilotAIVoice.startFromCheckin === 'function') {
              window.CarePilotAIVoice.startFromCheckin({
                scanValue: code,
                token: data.token || '',
                estimated_wait_min: data.estimated_wait_min || 0,
                display_name: data.display_name || ''
              });
            }

            scanningEnabled = false;
            cooldownUntil = Date.now() + 3000;
            setStatus('Checked in. Scan paused for 3 seconds...');
            setTimeout(function () {
              scanningEnabled = true;
              setStatus('Scanning for QR...');
            }, 3000);
          } else {
            setStatus(data.message || 'Code not found.');
          }
        } catch (err) {
          setStatus('Camera check-in error. Use manual fallback.');
        } finally {
          submitting = false;
        }
      }

      async function pollLastScan() {
        if (!scanningEnabled || submitting || Date.now() < cooldownUntil) return;
        try {
          const r = await fetch('/api/camera/last-scan', { cache: "no-store" });
          if (!r.ok) return;
          const data = await r.json();
          const v = String(data.value || '').trim();
          if (data.fresh && v && v !== lastProcessedValue) {
            lastProcessedValue = v;
            await submitCode(v, true);
          }
        } catch (err) {
          setStatus('Camera unavailable. Use manual fallback.');
        }
      }

      manualForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const code = (manualCode.value || '').trim();
        submitCode(code, false);
      });

      resumeBtn.addEventListener('click', function () {
        scanningEnabled = true;
        cooldownUntil = 0;
        setStatus('Scanning for QR...');
      });

      const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let rec = null;
      if (Recognition) {
        rec = new Recognition();
        rec.lang = 'en-US';
        rec.interimResults = false;
        rec.maxAlternatives = 1;
        rec.onstart = function () { voiceState.textContent = 'Listening'; micBtn.textContent = 'Listening...'; };
        rec.onend = function () { voiceState.textContent = 'Idle'; micBtn.textContent = 'Start Listening'; };
        rec.onresult = function (event) {
          const text = (event.results?.[0]?.[0]?.transcript || '').trim();
          if (!text) return;
          addBubble('user', text);
          voiceState.textContent = 'Processing';
          sendAssistantMessage(text).finally(function () { voiceState.textContent = 'Speaking'; });
        };
      } else {
        micBtn.disabled = true;
        micBtn.textContent = 'Voice Not Supported';
      }

      micBtn.addEventListener('click', function () {
        if (!rec) return;
        assistantAlert.style.display = 'none';
        rec.start();
      });

      setInterval(pollLastScan, 200);
      setStatus('Scanning for QR...');
    })();
  </script>
  
  <script>
/**
 * Kiosk AI Voice Flow (sequential)
 * - MUST NOT re-checkin (cooldown spam). We start ONLY after the main kiosk check-in succeeds.
 * - speaks steps via SpeechSynthesis
 * - waits for vitals from /api/vitals/by-token (your sensors/simulated vitals can fill this)
 */

(function(){
  const AI_NAME = "Astra"; // change name here
  let flowBusy = false;
  let lastFlowToken = "";
  let muted = false;

  function $(id){ return document.getElementById(id); }

  function setAIStatus(t){ if($("aiStatus")) $("aiStatus").innerText = t; }

  function setPriority(level, reason){
    const box = $("priorityBox");
    const v = $("priorityValue");
    const r = $("priorityReason");
    if(!box || !v || !r) return;

    box.classList.remove("high","medium","low");
    box.classList.add(level);

    const pretty = level === "high" ? "HIGH (RED)"
                 : level === "medium" ? "MEDIUM (ORANGE)"
                 : "LOW (YELLOW)";

    v.innerText = pretty;
    r.innerText = reason || "—";
  }

  function speak(text){
    if(muted) return;
    try{
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.02;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    } catch(e){}
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function waitForVitalsAndTriage(token, timeoutMs=20000){
    const start = Date.now();
    while(Date.now() - start < timeoutMs){
      const url = `/api/vitals/by-token?token=${encodeURIComponent(token)}`;
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      const data = await res.json();

      if(data && data.ok){
        const v = data.vitals || {};
        const hasVitals =
          v.spo2 != null || v.hr != null || v.temp_c != null || v.bp_sys != null || v.bp_dia != null;

        if(hasVitals){
          return data; // { ok:true, vitals: {...}, ... } + your server can add priority fields if you implement them
        }
      }
      setAIStatus("Reading vital signs… (waiting for sensors)");
      await sleep(900);
    }
    // timeout fallback
    return { ok:true, vitals:{}, priority:"medium", priority_reason:"Vitals not received yet — staff will verify.", pid:"" };
  }

  async function startFromCheckin(payload){
    // payload: {scanValue, token, estimated_wait_min, display_name}
    const token = (payload && payload.token) ? String(payload.token) : "";
    if(!token) return;

    // prevent re-running for same token immediately
    if(flowBusy) return;
    if(token === lastFlowToken) return;

    flowBusy = true;
    lastFlowToken = token;

    try{
      setAIStatus("AI assistant active.");
      setPriority("low", "—");

      // 1) Greeting
      await sleep(150);
      speak(`Greetings. My name is ${AI_NAME} and I will be your AI medical assistant. Before we get started, I am going to take a look at your vital signs.`);

      // 2) Wait for vitals
      await sleep(900);
      setAIStatus("Reading vital signs…");
      const triage = await waitForVitalsAndTriage(token, 25000);

      // 3) Determine priority (temporary logic until your backend adds real ML triage)
      // If your backend returns triage.priority / triage.priority_reason, we will use them.
      let level = (triage.priority || "").toLowerCase().trim();
      let reason = triage.priority_reason || "";

      if(level !== "high" && level !== "medium" && level !== "low"){
        // Simple placeholder rule-set based on vitals (non-diagnostic operational prioritization)
        const v = triage.vitals || {};
        const spo2 = (v.spo2 != null) ? Number(v.spo2) : null;
        const hr = (v.hr != null) ? Number(v.hr) : null;
        const temp = (v.temp_c != null) ? Number(v.temp_c) : null;

        // Default
        level = "low";
        reason = "Vitals appear within typical ranges (operational).";

        if((spo2 != null && spo2 < 92) || (hr != null && (hr > 130 || hr < 45)) || (temp != null && temp >= 39.0)){
          level = "high";
          reason = "Potential urgent vitals pattern detected — clinician review needed now.";
        } else if((spo2 != null && spo2 < 95) || (hr != null && (hr > 110 || hr < 55)) || (temp != null && temp >= 38.0)){
          level = "medium";
          reason = "Moderate vitals deviation — staff should review soon.";
        }
      }

      setPriority(level, reason);

      // 4) Speak next steps
      if(level === "high"){
        setAIStatus("HIGH priority — notifying staff.");
        speak("Your priority level is high. You may be experiencing a serious emergency condition. A clinician is being notified now. Please remain here. A doctor is coming.");
      } else if(level === "medium"){
        setAIStatus("MEDIUM priority — proceed to waiting area.");
        speak("Your priority level is medium. Please proceed to the waiting area and remain seated. Staff will call you soon.");
      } else {
        setAIStatus("LOW priority — proceed to waiting area.");
        speak("Your priority level is low. Please proceed to the waiting area and wait to be called.");
      }

    } catch(e){
      console.error(e);
      setAIStatus("AI flow error: " + (e.message || "unknown"));
      speak("Sorry, something went wrong. Please ask staff for help.");
    } finally {
      flowBusy = false;
    }
  }

  // expose to the main scan script
  window.CarePilotAIVoice = {
    startFromCheckin
  };

  window.addEventListener("load", () => {
    setAIStatus("Waiting for QR scan…");
    setPriority("low", "—");
  });
})();
  </script>

  <script src="/static/ux.js"></script>
</body>
</html>
