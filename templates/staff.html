<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarePilot Urgent - Staff</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="a11y-bar" role="region" aria-label="Accessibility and language">
    <button type="button" id="a11y-large" class="btn-a11y" aria-pressed="false">Large text</button>
    <button type="button" id="a11y-contrast" class="btn-a11y" aria-pressed="false">High contrast</button>
    <span class="lang-toggle" aria-label="Language"><button type="button" data-lang="en">EN</button><button type="button" data-lang="ar">AR</button></span>
  </div>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <div class="brand">CarePilot Urgent</div>
        {% if demo_mode %}<span class="demo-badge">DEMO MODE</span>{% endif %}
      </div>
      <nav class="nav">
        <a href="/">Portal</a>
        <a class="active" href="/staff">Staff</a>
        <a href="/analytics">Analytics</a>
        <form method="post" action="/staff/logout" style="display:inline;">
          <button type="submit" class="btn secondary" style="padding:.35rem .6rem;">Logout</button>
        </form>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="grid three">
      <div class="card">
        <div class="muted">Providers Available</div>
        <div class="kpi" id="provider-kpi">{{ provider_count }}</div>
        <label for="provider-select">Provider count</label>
        <select id="provider-select">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="card">
        <div class="muted">Current Queue</div>
        <div class="kpi" id="queue-kpi">0</div>
      </div>
      <div class="card">
        <div class="muted">Average Wait / Lane Mix</div>
        <div class="kpi" id="avg-wait-kpi">0 min</div>
        <div class="microcopy" id="lane-mix">Fast 0 • Standard 0 • Complex 0</div>
      </div>
    </div>

    <div class="card">
      <div class="btn-row">
        <button class="btn secondary" type="button" id="seed-demo-btn">Seed demo patients</button>
        <button class="btn danger" type="button" id="reset-btn">Reset</button>
      </div>
    </div>

    <h2 class="title">Live Staff Queue</h2>
    <div id="staff-queue" class="table-like"></div>
  </main>

  <script>
    function esc(v) { const d = document.createElement('div'); d.textContent = String(v ?? ''); return d.innerHTML; }
    const cacheById = {};

    function statusClass(s) {
      if (s === 'waiting') return 'status-waiting';
      if (s === 'called') return 'status-called';
      if (s === 'in_room') return 'status-in_room';
      return 'status-done';
    }

    function setStatus(pid, status) {
      const data = new FormData();
      data.append('status', status);
      fetch('/api/staff/status/' + encodeURIComponent(pid), { method: 'POST', body: data }).then(function (r) {
        if (r.status === 401) { window.location = '/staff/login'; return; }
        loadQueue();
      });
    }

    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise(function (resolve, reject) {
        try {
          const t = document.createElement('textarea');
          t.value = text;
          document.body.appendChild(t);
          t.select();
          document.execCommand('copy');
          document.body.removeChild(t);
          resolve();
        } catch (err) {
          reject(err);
        }
      });
    }

    function copyNoteById(id) {
      const item = cacheById[id];
      if (!item) return;
      const flags = (item.red_flags || []).length ? item.red_flags.join(', ') : 'none';
      const note =
        'Token: ' + item.token + '\n' +
        'Name: ' + (item.full_name || '-') + '\n' +
        'Chief complaint: ' + (item.chief_complaint || '-') + '\n' +
        'Symptoms: ' + ((item.symptom_list || []).join(', ') || '-') + '\n' +
        'Duration: ' + (item.duration_text || '-') + '\n' +
        'Cluster: ' + (item.ai_cluster || '-') + '\n' +
        'Red flags: ' + flags + '\n' +
        'Operational complexity: ' + (item.ai_complexity || '-') + '\n' +
        'Est visit: ' + (item.ai_visit_duration || 0) + '-' + ((item.ai_visit_duration || 0) + 10) + ' min\n' +
        'Est wait: ' + (item.estimated_wait_min || 0) + ' min\n' +
        'Suggested resources: ' + ((item.suggested_resources || []).join(', ') || '-');
      copyText(note).then(function () { alert('Handoff note copied.'); });
    }

    function loadQueue() {
      fetch('/api/staff-queue')
        .then(function (r) {
          if (r.status === 401) {
            window.location = '/staff/login';
            throw new Error('unauthorized');
          }
          return r.json();
        })
        .then(function (payload) {
          const items = payload.items || [];
          Object.keys(cacheById).forEach(function (k) { delete cacheById[k]; });
          items.forEach(function (i) { cacheById[i.id] = i; });

          document.getElementById('provider-kpi').textContent = payload.provider_count;
          document.getElementById('provider-select').value = String(payload.provider_count);
          document.getElementById('queue-kpi').textContent = items.length;
          document.getElementById('avg-wait-kpi').textContent = payload.avg_wait_min + ' min';
          const lc = payload.lane_counts || {};
          document.getElementById('lane-mix').textContent =
            'Fast ' + (lc.Fast || 0) + ' • Standard ' + (lc.Standard || 0) + ' • Complex ' + (lc.Complex || 0);
          const root = document.getElementById('staff-queue');
          if (!items.length) {
            root.innerHTML = '<div class="card muted">No patients in queue.</div>';
            return;
          }

          root.innerHTML = items.map(function (i) {
            const symptoms = esc(i.symptoms || '');
            const symptomBullets = (i.symptom_list || []).map(function (s) { return '<li>' + esc(s) + '</li>'; }).join('');
            const flags = (i.red_flags || []);
            const flagsHtml = flags.length ? '<span class="flag-badge">' + esc(flags.join(', ')) + '</span>' : '<span class="muted">none detected</span>';
            const resourcesBullets = (i.suggested_resources || []).map(function (s) { return '<li>' + esc(s) + '</li>'; }).join('');
            const resourceTags = (i.resource_tags || []).map(function (t) { return '<span class="status-pill">' + esc(t) + '</span>'; }).join(' ');

            return '<div class="patient-row">' +
              '<div style="display:flex;justify-content:space-between;gap:1rem;align-items:flex-start;">' +
                '<div>' +
                  '<strong>' + esc(i.token) + '</strong> <span class="muted">- ' + esc(i.full_name) + '</span><br>' +
                  '<span class="status-pill ' + statusClass(i.status) + '">' + esc(i.status_label) + '</span> ' +
                  '<span class="status-pill">' + esc(i.lane || 'Standard') + ' lane</span> ' +
                  '<span class="muted">Est wait ' + esc(i.estimated_wait_min) + ' min</span>' +
                '</div>' +
                '<div class="btn-row">' +
                  '<button class="btn warn" onclick="setStatus(\'' + esc(i.id) + '\',\'called\')">Call</button>' +
                  '<button class="btn ok" onclick="setStatus(\'' + esc(i.id) + '\',\'in_room\')">In Room</button>' +
                  '<button class="btn secondary" onclick="setStatus(\'' + esc(i.id) + '\',\'done\')">Done</button>' +
                  '<button class="btn secondary" onclick="simulateVitals(\'' + esc(i.id) + '\')">Sim Vitals</button>' +
                  '<button class="btn" onclick="copyNoteById(\'' + esc(i.id) + '\')">Copy Note</button>' +
                '</div>' +
              '</div>' +
              '<hr class="hr">' +
              '<div><strong>Chief complaint:</strong> ' + esc(i.chief_complaint || '-') + '</div>' +
              '<div><strong>Symptoms:</strong> ' + symptoms + '</div>' +
              '<ul class="muted" style="margin:.4rem 0 .4rem 1rem;">' + symptomBullets + '</ul>' +
              '<div class="muted"><strong>Duration:</strong> ' + esc(i.duration_text || '-') + '</div>' +
              '<div class="muted"><strong>Red flags:</strong> ' + flagsHtml + '</div>' +
              '<div class="card" style="margin-top:.6rem;">' +
                '<strong>AI Structured Intake (Operational, non-diagnostic)</strong><br>' +
                '<div class="muted">Cluster: ' + esc(i.ai_cluster) + '</div>' +
                '<div class="muted">Complexity: ' + esc(i.ai_complexity) + '</div>' +
                '<div class="muted">Estimated visit: ' + esc(i.ai_visit_duration) + '-' + (Number(i.ai_visit_duration || 0) + 10) + ' min</div>' +
                '<div class="muted">Estimated wait: ' + esc(i.estimated_wait_min) + ' min</div>' +
                '<div class="muted">Readiness tags: ' + resourceTags + '</div>' +
                '<div class="muted">Vitals: ' + esc(formatVitals(i.vitals_latest)) + '</div>' +
                '<div class="muted">Suggested resources:</div>' +
                '<ul class="muted" style="margin:.4rem 0 .2rem 1rem;">' + resourcesBullets + '</ul>' +
              '</div>' +
            '</div>';
          }).join('');
        });
    }

    function formatVitals(v) {
      if (!v) return 'pending';
      return 'SpO2 ' + (v.spo2 ?? '-') + '% • HR ' + (v.hr ?? '-') + ' bpm • Temp ' + (v.temp_c ?? '-') + ' C';
    }

    function simulateVitals(pid) {
      const fd = new FormData();
      fd.append('pid', pid);
      fetch('/api/vitals/simulate', { method: 'POST', body: fd }).then(loadQueue);
    }

    document.getElementById('provider-select').addEventListener('change', function (e) {
      const fd = new FormData();
      fd.append('count', e.target.value);
      fetch('/api/provider-count', { method: 'POST', body: fd }).then(function (r) {
        if (r.status === 401) { window.location = '/staff/login'; return; }
        loadQueue();
      });
    });

    document.getElementById('seed-demo-btn').addEventListener('click', function () {
      fetch('/demo/seed', { method: 'POST' }).then(function (r) {
        if (r.status === 401) { window.location = '/staff/login'; return; }
        loadQueue();
      });
    });

    document.getElementById('reset-btn').addEventListener('click', function () {
      if (!confirm('Reset all patients and demo data?')) return;
      fetch('/demo/reset', { method: 'POST' }).then(function (r) {
        if (r.status === 401) { window.location = '/staff/login'; return; }
        loadQueue();
      });
    });

    loadQueue();
    (function connectWs() {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(proto + '://' + location.host + '/ws/queue');
      ws.onmessage = function (event) {
        try {
          const payload = JSON.parse(event.data);
          if (payload && payload.type === 'queue_update') loadQueue();
        } catch (e) {}
      };
      ws.onclose = function () { setTimeout(connectWs, 1200); };
      ws.onerror = function () { ws.close(); };
    })();
    setInterval(loadQueue, 2000);
  </script>
  <script src="/static/ux.js"></script>
</body>
</html>
